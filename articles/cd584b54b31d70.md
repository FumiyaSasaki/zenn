---
title: "Nest.jsã¨Prismaã‚’Dockerã§ç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸ“"
type: "tech"
topics:
  - "docker"
  - "typescript"
  - "api"
  - "nestjs"
  - "prism"
published: true
published_at: "2024-10-15 22:20"
---

ã©ã†ã‚‚ã€ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®FUMIYAã§ã™ï¼
Express.jsã¯ã‚ˆãè§¦ã£ã¦ã¾ã—ãŸãŒã€Nest.jsã‚’è§¦ã£ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ç«‹ã¡ä¸Šã’ã¦ã¿ã¾ã—ãŸã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Nest.jsã§é–‹ç™ºã‚’ã—ã¦å­¦ã‚“ã ã“ã¨ã‚’ã¾ã¨ã‚ã¦ã„ãã¾ã™ã€‚

# Nest.jsã¨ã¯ï¼Ÿ

Nest.jsã¨ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¾ã§ä¸€è²«ã—ã¦TypeScriptã§ã®é–‹ç™ºã‚’å®Ÿç¾ã§ãã‚‹Expressã‚’ã‚³ã‚¢ã«ã—ã¦ä½œã‚‰ã‚Œã¦ã„ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

# ç›®çš„

Nest.jsã‚’dockerã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ç«‹ã¡ä¸Šã’ã¦APIã‚’é–‹ç™ºã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¾ã™ã€‚

# 1. Dockeræ§‹ç¯‰

1. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œã—ã€**Dockerfile**ã¨**docker-compose.yml**ã€**.dockerignore**ã‚’ä½œæˆã€‚
2. ä¸­èº«ã‚’ä¸‹è¨˜ã®é€šã‚Šã«ã™ã‚‹ã€‚

```powershell
touch Dockerfile docker-compose.yml .dockerignore
```

```yml:Dockerfile
FROM node:20

RUN npm i -g @nestjs/cli

WORKDIR /api
```

```yml:docker-compose.yml
version: '3.7'
services:
  nest:
    container_name: nest
    build: .
    tty: true
    ports:
      - '3000:3000'
    volumes:
      - type: bind
        source: .
        target: /api

```

```yml:.dockerignore
node_modules
```

3. ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ç«‹ã¡ä¸Šã’ã‚‹

```powershell
docker compose up -d --build
```

4. dockerãŒæ­£ã—ãç«‹ã¡ä¸ŠãŒã£ãŸã‹ç¢ºèª

```powershell
docker compose ps
```

# 2. Nestãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’Dockerä¸Šã«ä½œæˆ

1. Nestãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã«ã¦ä½œæˆ

```powershell
docker compose exec nest nest new .
```

2. package managerã‚’npmã§é¸æŠ

```powershell
? Which package manager would you â¤ï¸  to use? (Use arrow keys)
â¯ npm 
  yarn 
  pnpm
```

3. ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦[http://localhost:3000/](http://localhost:3000/)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦Hello World!ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª

```powershell
docker compose exec nest npm run start:dev
```

:::message
ã‚³ãƒãƒ³ãƒ‰ã‚’æ¯å›æ‰“ã¤ã®ã¯é¢å€’ãªã®ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ã—ã¦å†build
:::

```diff yml:Dockerfile
FROM node:20

RUN npm i -g @nestjs/cli

WORKDIR /api
+ COPY package*.json /api/ 

+ RUN npm i
+ CMD [ "npm", "run", "start:dev"]
```

# 3. MySQLã‚’è¿½åŠ 

1. docker-compose.ymlã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«ä¿®æ­£

```diff yml:docker-compose.yml
version: '3.7'
services:
  nest:
    container_name: nest
    build: .
    tty: true
    ports:
      - '3000:3000'
    volumes:
      - type: bind
        source: .
        target: /api
  db:
      platform: linux/x86_64
      image: mysql:5.7
      container_name: nest-prisma-sample-db
      environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: nest_prisma_sample
        MYSQL_PASSWORD: root
        TZ: 'Asia/Tokyo'
      command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
      volumes:
        - ./docker/db/my.cnf:/etc/mysql/conf.d/my.cnf
      ports:
        - 3306:3306

  phpmyadmin:
    container_name: nest-prisma-sample-phpmyadmin
    image: phpmyadmin/phpmyadmin
    environment:
      - PMA_ARBITRARY=1
      - PMA_HOSTS=nest-prisma-sample-db
      - PMA_USER=root
      - PMA_PASSWORD=root
    ports:
      - 8080:80
```

2. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦**dockerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**ã€**dbãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**ã€**my.cnf**ã€**.env**ã‚’ä½œæˆã€‚

```powershell
mkdir docker
mkdir docker/db
touch docker/db/my.cnf
touch .env
```

4. DBè¨­å®šã®my.cnfã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«ä¿®æ­£

```text:my.cnf
[mysqld]
default-authentication-plugin=mysql_native_password
character-set-server=utf8mb4

[mysql]
default-character-set=utf8mb4

[client]
default-character-set=utf8mb4
```

5. .envã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«ä¿®æ­£

```text:.env
DATABASE_URL="mysql://root:root@nestjs-demo-db:3306/nestjs_demo"
```

6. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦[http://localhost:8080/](http://localhost:8080/)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦phpmyadminã«ã€Œnest_prisma_sampleã€ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã§ãã¦ã„ã‚‹ã‹ç¢ºèª

```powershell
docker compose up
```

# 4. Prismaå°å…¥

1. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’é †ã«å®Ÿè¡Œã—ã¦Prismaã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨åˆæœŸåŒ–

**Prismaã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**

```powershell
docker compose run nest npm install --save-dev prisma
```

**åˆæœŸåŒ–**

```powershell
docker compose run nest npx prisma init
```

2. DBã‚’mysqlã«å¤‰æ›´ã¨Userãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã®ãŸã‚schema.prismaãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£

```js:prisma/schema.prisma
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  name       String
  email      String   @unique
  created    DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("users")
}
```

3. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒˆå®Ÿè¡Œã—ã¦prisma/migrationsã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã§ããŸã“ã¨ã‚’ç¢ºèª

```powershell
docker compose run nest npx prisma migrate dev --name init
```

# 4. PrismaClientã®å°å…¥

1. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§PrismaClientã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```powershell
docker compose run nest npm install @prisma/client
```

1. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§Prisma Client serviceä½œæˆã—ä¿®æ­£

:::message
PrismaServiceã¯PrismaClientã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã‚’è¡Œã†
:::

```js:src/prisma/prisma.service.ts
import { INestApplication, Injectable, OnModuleInit } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }

  async enableShutdownHooks(app: INestApplication) {
    process.on('beforeExit', async () => {
      await app.close();
    });
  }
}
```

2. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§Users serviceä½œæˆã—ä¿®æ­£

```powershell
docker-compose run nest nest generate service users
```

```js:src/users/users.service.ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from './../prisma/prisma.service';
import { User, Prisma } from '@prisma/client';

@Injectable()
export class UsersService {
  constructor(private prisma: PrismaService) {}

  async user(id: number): Promise<User | null> {
    return this.prisma.user.findUnique({
      where: { id },
    });
  }

  async users(): Promise<User[]> {
    return this.prisma.user.findMany();
  }

  async createUser(data: Prisma.UserCreateInput): Promise<User> {
    return this.prisma.user.create({
      data,
    });
  }
}
```

3. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§Usersã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ä½œæˆã—ä¿®æ­£

```powershell
docker-compose run nest nest g controller users
```

```js:src/users/users.controller.ts
import { Controller, Get, Param, Post, Body } from '@nestjs/common';
import { UsersService } from './users.service';
import { User } from '@prisma/client';

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Get(':id')
  async findUserById(@Param('id') id: string): Promise<User> {
    return this.usersService.user(Number(id));
  }

  @Get()
  async users(): Promise<User[]> {
    return this.usersService.users();
  }

  @Post()
  async createUser(
    @Body() userData: { name: string; email: string; password: string },
  ): Promise<User> {
    return this.usersService.createUser(userData);
  }
}
```

4. ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§Usersãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ä¿®æ­£

```powershell
docker-compose run nest nest g module users
```

```js:src/users/users.module.ts
import { Module } from '@nestjs/common';
import { UsersService } from './users.service';
import { UsersController } from './users.controller';
import { PrismaService } from './../prisma/prisma.service';

@Module({
  controllers: [UsersController],
  providers: [UsersService, PrismaService],
})
export class UsersModule {}
```

5. å‹•ä½œç¢ºèª

**createUserå®Ÿè¡Œ**

```powershell
curl -H "content-type: application/json" -X POST -d'{"name":"test", "email":"test@sample.com"}' http://localhost:3000/users
```

**findUserByIdå®Ÿè¡Œ**

```powershell
curl -X GET http://localhost:3000/users/1
```

**userså®Ÿè¡Œ**

```powershell
curl -X GET http://localhost:3000/users
```
